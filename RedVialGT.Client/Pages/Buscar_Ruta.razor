@page "/buscar-ruta"

@using System.Collections.Generic
@using System.Linq
@using RedVialGT.Shared
@using RedVialGT.Client.Services
@using System.Text.Json
@using Microsoft.JSInterop

@inject IRutaService rutaService

<h3>Buscar Ruta entre Departamentos</h3>

<div class="input-group mb-3">
    <label class="input-group-text" for="selectRutaPartida">Seleccionar Departamento de Partida</label>
    <select class="form-select" id="selectRutaPartida" @bind="idRutaPartida">
        <option value="0">Selecciona un departamento...</option>
        @if (listaRutas != null)
        {
            foreach (var ruta in listaRutas)
            {
                <option value="@ruta.IdRuta">@ruta.NombreRuta</option>
            }
        }
        else
        {
            <p>El objeto es null.</p>
        }
    </select>
    <button class="btn btn-secondary" @onclick="MostrarDatosDepartamentoPartida">Mostrar Datos</button>
</div>

<div class="input-group mb-3">
    <label class="input-group-text" for="selectRutaDestino">Seleccionar Departamento de Destino</label>
    <select class="form-select" id="selectRutaDestino" @bind="idRutaDestino">
        <option value="0">Selecciona un departamento...</option>
        @if (listaRutas != null)
        {
            foreach (var ruta in listaRutas)
            {
                <option value="@ruta.IdRuta">@ruta.NombreRuta</option>
            }
        }
        else
        {
            <p>El objeto es null.</p>
        }
    </select>
    <button class="btn btn-secondary" @onclick="MostrarDatosDepartamentoDestino">Mostrar Datos</button>
</div>

<button class="btn btn-primary" @onclick="BuscarRuta">Buscar Ruta</button>

<div>
    @if (departamentoSeleccionado != null)
    {
        <table class="table table-condensed">
            <tr>
                <td><strong>Cabecera Departamental:</strong></td>
                <td>@departamentoSeleccionado.NombreCabecera</td>
            </tr>
            <tr>
                <td><strong>Cantidad Poblacional:</strong></td>
                <td>@($"{departamentoSeleccionado.CantidadPoblacion:#,0}")</td>
            </tr>
            <tr>
                <td><strong>Cantidad de municipios:</strong></td>
                <td>@departamentoSeleccionado.CantidadMunicipios</td>
            </tr>
            <tr>
                <td><strong>Lugares Turísticos:</strong></td>
                <td>
                    @if (!string.IsNullOrEmpty(departamentoSeleccionado.LugaresTuristicos))
                    {
                        <ul>
                            @foreach (var lugar in departamentoSeleccionado.LugaresTuristicos.Split(','))
                            {
                                <li>@lugar.Trim()</li>
                            }
                        </ul>
                    }
                    else
                    {
                        <p>No hay lugares turísticos registrados.</p>
                    }
                </td>
            </tr>
        </table>
    }
</div>

@if (nodosIntermedios != null && nodosIntermedios.Any())
{
    <h4>Ruta más corta - Distancia Total: @CalcularDistanciaTotal(nodosIntermedios[0]) Kms</h4>
    <div class="horizontal-list">
        @foreach (var nodo in nodosIntermedios[0])
        {
            <span class="list-item">*</span>
            <span class="list-item">@nodo.ruta.NombreRuta</span>
            @if (nodo != nodosIntermedios[0].Last())
            {
                <span class="separator">   =>   </span>
            }
        }
    </div>

    <h4>Ruta más larga - Distancia Total: @CalcularDistanciaTotal(nodosIntermedios[1]) Kms</h4>
    <div class="horizontal-list">
        @foreach (var nodo in nodosIntermedios[1])
        {
            <span class="list-item">*</span>
            <span class="list-item">@nodo.ruta.NombreRuta</span>
            @if (nodo != nodosIntermedios[1].Last())
            {
                <span class="separator">   =>   </span>
            }
        }
    </div>
}

@code {
    int idRutaPartida;
    int idRutaDestino;
    List<RutaDTO> listaRutas;
    List<List<Nodo>> nodosIntermedios;
    ListasCuadruplementeEnlazadas listasCuadruplementeEnlazadas;
    DepartamentoDTO departamentoSeleccionado;

    protected override async Task OnInitializedAsync()
    {
        listaRutas = await rutaService.ListaDestino();
        listasCuadruplementeEnlazadas = new ListasCuadruplementeEnlazadas(rutaService);
        await listasCuadruplementeEnlazadas.CrearNodosDesdeBD();
    }

    async Task BuscarRuta()
    {
        if (idRutaPartida != 0 && idRutaDestino != 0)
        {
            var rutaPartidaCompleta = await rutaService.Buscar(idRutaPartida);
            var rutaDestinoCompleta = await rutaService.Buscar(idRutaDestino);

            if (rutaPartidaCompleta != null && rutaDestinoCompleta != null)
            {
                var nodoPartida = listasCuadruplementeEnlazadas.BuscarNodoPorRuta(rutaPartidaCompleta);
                var nodoDestino = listasCuadruplementeEnlazadas.BuscarNodoPorRuta(rutaDestinoCompleta);

                if (nodoPartida != null && nodoDestino != null)
                {
                    nodosIntermedios = BuscarNodosIntermediosEntreRutas(nodoPartida, nodoDestino);
                }
                else
                {
                    nodosIntermedios = null;
                }
            }
        }
    }

    List<List<Nodo>> BuscarNodosIntermediosEntreRutas(Nodo nodoPartida, Nodo nodoDestino)
    {
        var nodosIntermediosCorta = new List<Nodo>();
        var nodosIntermediosLarga = new List<Nodo>();
        var rutaActual = new List<Nodo>();

        BuscarRutaDFS(nodoPartida, nodoDestino, rutaActual, nodosIntermediosCorta, nodosIntermediosLarga);

        return new List<List<Nodo>> { nodosIntermediosCorta, nodosIntermediosLarga };
    }

    void BuscarRutaDFS(Nodo nodoActual, Nodo nodoDestino, List<Nodo> rutaActual, List<Nodo> nodosIntermediosCorta, List<Nodo> nodosIntermediosLarga)
    {
        rutaActual.Add(nodoActual);

        if (nodoActual == nodoDestino)
        {
            if (nodosIntermediosCorta.Count == 0 || rutaActual.Count < nodosIntermediosCorta.Count)
            {
                nodosIntermediosCorta.Clear();
                nodosIntermediosCorta.AddRange(rutaActual);
            }
            if (nodosIntermediosLarga.Count == 0 || rutaActual.Count > nodosIntermediosLarga.Count)
            {
                nodosIntermediosLarga.Clear();
                nodosIntermediosLarga.AddRange(rutaActual);
            }
        }
        else
        {
            if (nodoActual.ligaNorte != null && !rutaActual.Contains(nodoActual.ligaNorte))
            {
                BuscarRutaDFS(nodoActual.ligaNorte, nodoDestino, rutaActual, nodosIntermediosCorta, nodosIntermediosLarga);
            }
            if (nodoActual.ligaSur != null && !rutaActual.Contains(nodoActual.ligaSur))
            {
                BuscarRutaDFS(nodoActual.ligaSur, nodoDestino, rutaActual, nodosIntermediosCorta, nodosIntermediosLarga);
            }
            if (nodoActual.ligaEste != null && !rutaActual.Contains(nodoActual.ligaEste))
            {
                BuscarRutaDFS(nodoActual.ligaEste, nodoDestino, rutaActual, nodosIntermediosCorta, nodosIntermediosLarga);
            }
            if (nodoActual.ligaOeste != null && !rutaActual.Contains(nodoActual.ligaOeste))
            {
                BuscarRutaDFS(nodoActual.ligaOeste, nodoDestino, rutaActual, nodosIntermediosCorta, nodosIntermediosLarga);
            }
        }

        rutaActual.Remove(nodoActual);
    }

    string CalcularDistanciaTotal(List<Nodo> nodos)
    {
        double distanciaTotal = 0;
        for (int i = 1; i < nodos.Count; i++)
        {
            double distancia = nodos[i].ruta.DistanciaDepartamentos;
            if (distancia == 0)
            {
                distanciaTotal += 50; // Sumar 50 kilómetros si la distancia es cero
            }
            else
            {
                distanciaTotal += distancia;
            }
        }
        return distanciaTotal.ToString("#,##0.00");
    }

    async Task MostrarDatosDepartamentoDestino()
    {
        if (idRutaDestino != 0)
        {
            var rutaDestinoCompleta = await rutaService.Buscar(idRutaDestino);
            if (rutaDestinoCompleta != null)
            {
                departamentoSeleccionado = rutaDestinoCompleta.DepartamentoDestino;
            }
        }
    }

    async Task MostrarDatosDepartamentoPartida()
    {
        if (idRutaPartida != 0)
        {
            var rutaPartidaCompleta = await rutaService.Buscar(idRutaPartida);
            if (rutaPartidaCompleta != null)
            {
                departamentoSeleccionado = rutaPartidaCompleta.DepartamentoDestino;
            }
        }
    }
}
